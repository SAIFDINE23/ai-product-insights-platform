name: CI/CD - Build, Scan, Push

on:
  push:
    branches: ["main"]

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_SCRAPER: ${{ secrets.DOCKERHUB_USERNAME }}/scraper
  IMAGE_AI_ANALYSIS: ${{ secrets.DOCKERHUB_USERNAME }}/ai-analysis
  IMAGE_STATS: ${{ secrets.DOCKERHUB_USERNAME }}/stats
  IMAGE_FRONTEND: ${{ secrets.DOCKERHUB_USERNAME }}/frontend

jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      # Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # Setup Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Login to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Build images with latest and commit SHA tags
      - name: Build Scraper Service
        uses: docker/build-push-action@v5
        with:
          context: backend/scraper-service
          tags: |
            ${{ env.IMAGE_SCRAPER }}:latest
            ${{ env.IMAGE_SCRAPER }}:${{ github.sha }}
          load: true

      - name: Build AI Analysis Service
        uses: docker/build-push-action@v5
        with:
          context: backend/ai-analysis-service
          tags: |
            ${{ env.IMAGE_AI_ANALYSIS }}:latest
            ${{ env.IMAGE_AI_ANALYSIS }}:${{ github.sha }}
          load: true

      - name: Build Stats Service
        uses: docker/build-push-action@v5
        with:
          context: backend/stats-service
          tags: |
            ${{ env.IMAGE_STATS }}:latest
            ${{ env.IMAGE_STATS }}:${{ github.sha }}
          load: true

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: frontend/dashboard-react
          tags: |
            ${{ env.IMAGE_FRONTEND }}:latest
            ${{ env.IMAGE_FRONTEND }}:${{ github.sha }}
          load: true

      # Security scan (fail if CRITICAL vulnerabilities are found)
      - name: Trivy Scan - Scraper
        uses: aquasecurity/trivy-action@0.23.0
        with:
          image-ref: ${{ env.IMAGE_SCRAPER }}:latest
          format: table
          severity: CRITICAL
          exit-code: 1
          ignore-unfixed: true

      - name: Trivy Scan - AI Analysis
        uses: aquasecurity/trivy-action@0.23.0
        with:
          image-ref: ${{ env.IMAGE_AI_ANALYSIS }}:latest
          format: table
          severity: CRITICAL
          exit-code: 1
          ignore-unfixed: true

      - name: Trivy Scan - Stats
        uses: aquasecurity/trivy-action@0.23.0
        with:
          image-ref: ${{ env.IMAGE_STATS }}:latest
          format: table
          severity: CRITICAL
          exit-code: 1
          ignore-unfixed: true

      - name: Trivy Scan - Frontend
        uses: aquasecurity/trivy-action@0.23.0
        with:
          image-ref: ${{ env.IMAGE_FRONTEND }}:latest
          format: table
          severity: CRITICAL
          exit-code: 1
          ignore-unfixed: true

      # Push images to Docker Hub
      - name: Push images
        run: |
          docker push $IMAGE_SCRAPER:latest
          docker push $IMAGE_SCRAPER:${GITHUB_SHA}
          docker push $IMAGE_AI_ANALYSIS:latest
          docker push $IMAGE_AI_ANALYSIS:${GITHUB_SHA}
          docker push $IMAGE_STATS:latest
          docker push $IMAGE_STATS:${GITHUB_SHA}
          docker push $IMAGE_FRONTEND:latest
          docker push $IMAGE_FRONTEND:${GITHUB_SHA}
